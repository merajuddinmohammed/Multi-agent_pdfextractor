<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document Intelligence — Multi-Agent Analysis</title>
  <style>
    /* ── Reset & Base ──────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0b0f1a;
      --surface: #111827;
      --surface2: #1a2234;
      --border: #1e2a3a;
      --text: #e2e8f0;
      --text-muted: #8892a4;
      --accent: #6366f1;
      --accent-glow: rgba(99,102,241,.25);
      --green: #10b981;
      --amber: #f59e0b;
      --red: #ef4444;
      --blue: #3b82f6;
      --radius: 12px;
      --radius-sm: 8px;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ── Layout ────────────────────────────────────────── */
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    /* ── Header ────────────────────────────────────────── */
    .header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: .35rem 1rem;
      font-size: .75rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .header-badge .dot {
      width: 6px; height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .4; }
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #e2e8f0, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: .5rem;
    }

    .header p {
      color: var(--text-muted);
      font-size: .95rem;
    }

    /* ── Upload Zone ───────────────────────────────────── */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 3rem 2rem;
      text-align: center;
      transition: all .25s;
      cursor: pointer;
      background: var(--surface);
      position: relative;
    }

    .upload-zone:hover,
    .upload-zone.drag-over {
      border-color: var(--accent);
      background: rgba(99,102,241,.04);
      box-shadow: 0 0 30px var(--accent-glow);
    }

    .upload-zone input { display: none; }

    .upload-icon {
      width: 56px; height: 56px;
      margin: 0 auto 1rem;
      background: var(--surface2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .upload-icon svg { width: 26px; height: 26px; color: var(--accent); }

    .upload-zone h3 {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: .35rem;
    }

    .upload-zone p {
      color: var(--text-muted);
      font-size: .85rem;
    }

    .file-info {
      display: none;
      align-items: center;
      gap: .75rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: .75rem 1rem;
      margin-top: 1.25rem;
      text-align: left;
    }

    .file-info.visible { display: flex; }

    .file-info .file-icon {
      width: 40px; height: 40px;
      background: rgba(239,68,68,.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .file-info .file-icon svg { width: 20px; height: 20px; color: var(--red); }

    .file-info .file-meta { flex: 1; }
    .file-info .file-name { font-weight: 600; font-size: .9rem; }
    .file-info .file-size { color: var(--text-muted); font-size: .8rem; }

    .file-info .remove-btn {
      background: none; border: none; cursor: pointer;
      color: var(--text-muted); padding: 4px;
      border-radius: 4px; transition: color .2s;
    }
    .file-info .remove-btn:hover { color: var(--red); }

    /* ── Analyze Button ────────────────────────────────── */
    .analyze-btn {
      display: block;
      width: 100%;
      margin-top: 1.5rem;
      padding: 1rem;
      border: none;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--accent), #4f46e5);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      letter-spacing: .02em;
    }

    .analyze-btn:hover:not(:disabled) {
      box-shadow: 0 0 24px var(--accent-glow);
      transform: translateY(-1px);
    }

    .analyze-btn:disabled {
      opacity: .35;
      cursor: not-allowed;
    }

    /* ── Processing State ──────────────────────────────── */
    .processing {
      display: none;
      margin-top: 2rem;
    }

    .processing.visible { display: block; }

    .agent-status-list {
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }

    .agent-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1rem 1.25rem;
    }

    .agent-status .indicator {
      width: 36px; height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .agent-status .indicator.waiting { background: var(--surface2); }
    .agent-status .indicator.running {
      background: rgba(99,102,241,.15);
      animation: pulse 1.2s infinite;
    }
    .agent-status .indicator.done { background: rgba(16,185,129,.15); }

    .agent-status .indicator svg { width: 18px; height: 18px; }
    .agent-status .indicator.waiting svg { color: var(--text-muted); }
    .agent-status .indicator.running svg { color: var(--accent); }
    .agent-status .indicator.done svg { color: var(--green); }

    .agent-status .label { font-weight: 600; font-size: .9rem; flex: 1; }
    .agent-status .tag {
      font-size: .7rem;
      padding: .2rem .6rem;
      border-radius: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    .tag.waiting { background: var(--surface2); color: var(--text-muted); }
    .tag.running { background: rgba(99,102,241,.15); color: var(--accent); }
    .tag.done { background: rgba(16,185,129,.15); color: var(--green); }

    /* ── Results ───────────────────────────────────────── */
    .results {
      display: none;
      margin-top: 2.5rem;
    }

    .results.visible { display: block; }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .results-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .results-meta {
      display: flex;
      gap: 1.5rem;
      font-size: .8rem;
      color: var(--text-muted);
    }

    .results-meta span {
      display: flex;
      align-items: center;
      gap: .35rem;
    }

    .result-cards {
      display: grid;
      gap: 1.25rem;
    }

    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }

    .card-icon {
      width: 32px; height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-icon svg { width: 16px; height: 16px; }
    .card-icon.summary { background: rgba(99,102,241,.15); }
    .card-icon.summary svg { color: var(--accent); }
    .card-icon.actions { background: rgba(59,130,246,.15); }
    .card-icon.actions svg { color: var(--blue); }
    .card-icon.risks { background: rgba(245,158,11,.15); }
    .card-icon.risks svg { color: var(--amber); }

    .card-header .card-title {
      font-weight: 600;
      font-size: .95rem;
      flex: 1;
    }

    .card-header .card-count {
      font-size: .75rem;
      color: var(--text-muted);
      background: var(--surface);
      padding: .15rem .6rem;
      border-radius: 10px;
    }

    .card-body { padding: 1.25rem; }

    .summary-text {
      color: var(--text);
      font-size: .92rem;
      line-height: 1.75;
    }

    /* ── Action Table ──────────────────────────────────── */
    .action-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .85rem;
    }

    .action-table th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 600;
      padding: .6rem .75rem;
      border-bottom: 1px solid var(--border);
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .action-table td {
      padding: .75rem;
      border-bottom: 1px solid rgba(30,42,58,.5);
      vertical-align: top;
    }

    .action-table tr:last-child td { border-bottom: none; }

    .action-table .owner-badge {
      display: inline-block;
      background: rgba(99,102,241,.12);
      color: var(--accent);
      padding: .15rem .55rem;
      border-radius: 6px;
      font-size: .78rem;
      font-weight: 500;
    }

    .action-table .dep-badge {
      display: inline-block;
      background: rgba(245,158,11,.1);
      color: var(--amber);
      padding: .15rem .55rem;
      border-radius: 6px;
      font-size: .78rem;
      font-weight: 500;
    }

    .action-table .deadline-badge {
      display: inline-block;
      background: rgba(16,185,129,.1);
      color: var(--green);
      padding: .15rem .55rem;
      border-radius: 6px;
      font-size: .78rem;
      font-weight: 500;
    }

    .null-val { color: var(--text-muted); font-style: italic; font-size: .8rem; }

    /* ── Risk List ─────────────────────────────────────── */
    .risk-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: .6rem;
    }

    .risk-item {
      display: flex;
      align-items: flex-start;
      gap: .75rem;
      padding: .75rem 1rem;
      background: rgba(245,158,11,.04);
      border: 1px solid rgba(245,158,11,.12);
      border-radius: var(--radius-sm);
      font-size: .88rem;
      line-height: 1.5;
    }

    .risk-item .risk-icon {
      flex-shrink: 0;
      margin-top: 2px;
      color: var(--amber);
    }

    .risk-item .risk-icon svg { width: 16px; height: 16px; }

    /* ── JSON Output Panel ─────────────────────────────── */
    .json-toggle-bar {
      display: flex;
      align-items: center;
      gap: .75rem;
      margin-bottom: 1.25rem;
    }

    .view-btn {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .5rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      color: var(--text-muted);
      font-size: .82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }

    .view-btn:hover { border-color: var(--accent); color: var(--text); }
    .view-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .view-btn svg { width: 15px; height: 15px; }

    .download-btn {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .5rem 1.1rem;
      border: 1px solid var(--green);
      border-radius: var(--radius-sm);
      background: rgba(16,185,129,.08);
      color: var(--green);
      font-size: .82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }

    .download-btn:hover {
      background: rgba(16,185,129,.18);
      box-shadow: 0 0 16px rgba(16,185,129,.15);
    }

    .download-btn svg { width: 15px; height: 15px; }

    .json-panel {
      display: none;
    }

    .json-panel.visible { display: block; }

    .json-output {
      background: #0d1117;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }

    .json-output pre {
      margin: 0;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: .82rem;
      line-height: 1.65;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .json-output .json-key { color: #7dd3fc; }
    .json-output .json-string { color: #86efac; }
    .json-output .json-number { color: #fbbf24; }
    .json-output .json-null { color: #a78bfa; font-style: italic; }
    .json-output .json-bracket { color: #94a3b8; }

    /* ── Responsive ────────────────────────────────────── */
    @media (max-width: 640px) {
      .app { padding: 1rem; }
      .header h1 { font-size: 1.5rem; }
      .upload-zone { padding: 2rem 1rem; }
      .results-header { flex-direction: column; gap: .75rem; align-items: flex-start; }
      .action-table { font-size: .78rem; }
      .action-table th, .action-table td { padding: .5rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header">
      <div class="header-badge"><span class="dot"></span> Multi-Agent System</div>
      <h1>Document Intelligence</h1>
      <p>Upload a PDF document and let 3 AI agents analyze it in parallel</p>
    </div>

    <!-- Upload -->
    <div class="upload-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".pdf">
      <div class="upload-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16V4m0 0l-4 4m4-4l4 4M4 20h16"/></svg>
      </div>
      <h3>Drop your PDF here</h3>
      <p>or click to browse — max 20 MB</p>
      <div class="file-info" id="fileInfo">
        <div class="file-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </div>
        <div class="file-meta">
          <div class="file-name" id="fileName">—</div>
          <div class="file-size" id="fileSize">—</div>
        </div>
        <button class="remove-btn" id="removeBtn" title="Remove file">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </div>

    <button class="analyze-btn" id="analyzeBtn" disabled>Analyze Document</button>

    <!-- Processing -->
    <div class="processing" id="processing">
      <div class="agent-status-list">
        <div class="agent-status" id="statusSummary">
          <div class="indicator running" id="indSummary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          </div>
          <span class="label">Summary Agent</span>
          <span class="tag running" id="tagSummary">Running</span>
        </div>
        <div class="agent-status" id="statusAction">
          <div class="indicator running" id="indAction">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2M9 5h6m-3 4v6m-3-3h6"/></svg>
          </div>
          <span class="label">Action & Dependency Agent</span>
          <span class="tag running" id="tagAction">Running</span>
        </div>
        <div class="agent-status" id="statusRisk">
          <div class="indicator running" id="indRisk">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <span class="label">Risk & Open-Issues Agent</span>
          <span class="tag running" id="tagRisk">Running</span>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="results" id="results">
      <div class="results-header">
        <h2>Analysis Results</h2>
        <div class="results-meta">
          <span id="metaChunks">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            — chunks
          </span>
          <span id="metaTime">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            — seconds
          </span>
        </div>
      </div>

      <!-- View Toggle + Download -->
      <div class="json-toggle-bar">
        <button class="view-btn active" id="viewCards" title="Card view">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
          Cards
        </button>
        <button class="view-btn" id="viewJson" title="JSON view">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
          JSON
        </button>
        <button class="download-btn" id="downloadJson" title="Download JSON">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"/></svg>
          Download JSON
        </button>
      </div>

      <!-- JSON Panel -->
      <div class="json-panel" id="jsonPanel">
        <div class="json-output">
          <pre id="jsonPre"></pre>
        </div>
      </div>

      <div class="result-cards" id="cardsPanel">
        <!-- Summary Card -->
        <div class="result-card">
          <div class="card-header">
            <div class="card-icon summary">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <span class="card-title">Summary</span>
          </div>
          <div class="card-body">
            <p class="summary-text" id="summaryText">—</p>
          </div>
        </div>

        <!-- Actions Card -->
        <div class="result-card">
          <div class="card-header">
            <div class="card-icon actions">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2M9 5h6m-3 4v6m-3-3h6"/></svg>
            </div>
            <span class="card-title">Actions & Dependencies</span>
            <span class="card-count" id="actionCount">—</span>
          </div>
          <div class="card-body" style="padding:0;">
            <table class="action-table">
              <thead>
                <tr><th>Task</th><th>Owner</th><th>Dependency</th><th>Deadline</th></tr>
              </thead>
              <tbody id="actionTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Risks Card -->
        <div class="result-card">
          <div class="card-header">
            <div class="card-icon risks">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <span class="card-title">Risks & Open Issues</span>
            <span class="card-count" id="riskCount">—</span>
          </div>
          <div class="card-body">
            <ul class="risk-list" id="riskList"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Error -->
    <div id="errorBox" style="display:none; margin-top:1.5rem; padding:1rem 1.25rem; background:rgba(239,68,68,.08); border:1px solid rgba(239,68,68,.25); border-radius:8px; color:#fca5a5; font-size:.9rem;"></div>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeBtn = document.getElementById('removeBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const processing = document.getElementById('processing');
    const results = document.getElementById('results');
    const errorBox = document.getElementById('errorBox');

    let selectedFile = null;
    let lastResultData = null;

    // ── File Selection ──
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    removeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      clearFile();
    });

    function handleFile(file) {
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.pdf')) {
        showError('Please upload a PDF file.');
        return;
      }
      if (file.size > 20 * 1024 * 1024) {
        showError('File too large. Max size is 20 MB.');
        return;
      }
      selectedFile = file;
      fileName.textContent = file.name;
      fileSize.textContent = formatSize(file.size);
      fileInfo.classList.add('visible');
      analyzeBtn.disabled = false;
      hideError();
    }

    function clearFile() {
      selectedFile = null;
      fileInput.value = '';
      fileInfo.classList.remove('visible');
      analyzeBtn.disabled = true;
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // ── Analyze ──
    analyzeBtn.addEventListener('click', analyze);

    async function analyze() {
      if (!selectedFile) return;

      hideError();
      results.classList.remove('visible');
      processing.classList.add('visible');
      analyzeBtn.disabled = true;

      setAgentStatus('Summary', 'running');
      setAgentStatus('Action', 'running');
      setAgentStatus('Risk', 'running');

      const form = new FormData();
      form.append('file', selectedFile);

      try {
        const resp = await fetch('/api/analyze', { method: 'POST', body: form });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ detail: 'Server error' }));
          throw new Error(err.detail || `HTTP ${resp.status}`);
        }

        const data = await resp.json();

        setAgentStatus('Summary', 'done');
        setAgentStatus('Action', 'done');
        setAgentStatus('Risk', 'done');

        renderResults(data);
      } catch (err) {
        showError(err.message);
        processing.classList.remove('visible');
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    function setAgentStatus(name, state) {
      const ind = document.getElementById('ind' + name);
      const tag = document.getElementById('tag' + name);
      ind.className = 'indicator ' + state;
      tag.className = 'tag ' + state;
      tag.textContent = state === 'running' ? 'Running' : state === 'done' ? 'Done' : 'Waiting';
    }

    // ── Render ──
    function renderResults(data) {
      lastResultData = data;

      // Populate JSON panel
      document.getElementById('jsonPre').innerHTML = syntaxHighlight(data);

      const r = data.results;

      // Meta
      document.getElementById('metaChunks').innerHTML =
        `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg> ${data.chunks_processed} chunks`;
      document.getElementById('metaTime').innerHTML =
        `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> ${data.processing_time_seconds}s`;

      // Summary
      const summaryData = r.summary;
      document.getElementById('summaryText').textContent =
        summaryData.summary || JSON.stringify(summaryData);

      // Actions
      const actionsData = r.actions;
      const actions = actionsData.actions || [];
      document.getElementById('actionCount').textContent = actions.length + ' items';

      const tbody = document.getElementById('actionTableBody');
      tbody.innerHTML = '';
      actions.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(a.task)}</td>
          <td>${a.owner ? `<span class="owner-badge">${esc(a.owner)}</span>` : '<span class="null-val">—</span>'}</td>
          <td>${a.dependency ? `<span class="dep-badge">${esc(a.dependency)}</span>` : '<span class="null-val">—</span>'}</td>
          <td>${a.deadline ? `<span class="deadline-badge">${esc(a.deadline)}</span>` : '<span class="null-val">—</span>'}</td>
        `;
        tbody.appendChild(tr);
      });

      // Risks
      const risksData = r.risks;
      const risks = risksData.risks || [];
      document.getElementById('riskCount').textContent = risks.length + ' items';

      const riskList = document.getElementById('riskList');
      riskList.innerHTML = '';
      risks.forEach(risk => {
        const li = document.createElement('li');
        li.className = 'risk-item';
        li.innerHTML = `
          <span class="risk-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg></span>
          <span>${esc(risk)}</span>
        `;
        riskList.appendChild(li);
      });

      results.classList.add('visible');
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    // ── View Toggle ──
    const viewCards = document.getElementById('viewCards');
    const viewJson = document.getElementById('viewJson');
    const cardsPanel = document.getElementById('cardsPanel');
    const jsonPanel = document.getElementById('jsonPanel');
    const downloadJson = document.getElementById('downloadJson');

    viewCards.addEventListener('click', () => {
      viewCards.classList.add('active');
      viewJson.classList.remove('active');
      cardsPanel.style.display = '';
      jsonPanel.classList.remove('visible');
    });

    viewJson.addEventListener('click', () => {
      viewJson.classList.add('active');
      viewCards.classList.remove('active');
      cardsPanel.style.display = 'none';
      jsonPanel.classList.add('visible');
    });

    downloadJson.addEventListener('click', () => {
      if (!lastResultData) return;
      const blob = new Blob([JSON.stringify(lastResultData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const name = lastResultData.filename ? lastResultData.filename.replace('.pdf', '') : 'analysis';
      a.download = name + '_results.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // ── JSON Syntax Highlighting ──
    function syntaxHighlight(json) {
      const str = JSON.stringify(json, null, 2);
      return str.replace(/("(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g, (match) => {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
            return '<span class="' + cls + '">' + escHtml(match.slice(0, -1)) + '</span>:';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-string';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + escHtml(match) + '</span>';
      }).replace(/([{}[\]])/g, '<span class="json-bracket">$1</span>');
    }

    function escHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ── Error ──
    function showError(msg) { errorBox.textContent = msg; errorBox.style.display = 'block'; }
    function hideError() { errorBox.style.display = 'none'; }
  </script>
</body>
</html>
